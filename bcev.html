<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Bon de Commande</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family:"Segoe UI",Arial,sans-serif; background:#f7f7f7; padding:20px; }
  .page { background:white; max-width:600px; margin:auto; padding:30px; box-shadow:0 0 10px rgba(0,0,0,0.15); border-radius:10px; }
  h1 { text-align:center; font-size:22px; font-weight:bold; margin-bottom:25px; text-transform:uppercase; }
  table { width:100%; border-collapse:collapse; margin-top:15px; font-size:14px; }
  th, td { border:1px solid #000; padding:6px; text-align:center; }
  th { background:#f2f2f2; font-weight:600; }
  input, select { border:1px solid #ccc; border-radius:4px; padding:2px 4px; width:100%; text-align:center; }
  .btns { text-align:center; margin-top:20px; }
  .btns button { background:#2563eb; color:white; padding:10px 20px; border-radius:6px; margin:4px; cursor:pointer; border:none; transition:background 0.3s; }
  .btns button:hover { background:#1e40af; }
  .header { display:flex; justify-content:space-between; flex-wrap:wrap; gap:20px; margin-bottom:15px; font-size:14px; line-height:1.5; }
  .inline-input { display:flex; justify-content:flex-end; align-items:center; gap:6px; margin-bottom:5px; }
  .inline-input label { font-weight:600; }
  .inline-input input { width:120px; text-align:center; }
</style>
</head>
<body>

<div class="page">
  <h1>BON DE COMMANDE</h1>

  <div class="header">
    <div>
      <label for="clientSelect"><strong>Fournisseur :</strong></label><br>
      <select id="clientSelect">
        <option value="kamel">TABBOU KAMEL</option>
        <option value="abdellah">TABBOU ABDELLAH</option>
      </select>
    </div>
    <div>
      <div class="inline-input">
        <label>Num√©ro BC :</label>
        <button onclick="genererNumeroBon()">Nouveau bon</button>
        <input type="text" id="numero" placeholder="Num√©ro BC">
      </div>
      <div class="inline-input">
        <label>Date :</label>
        <input id="dateBon" type="date">
      </div>
    </div>
  </div>

  <table id="table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Num√©ro BC</th>
        <th>Fournisseur</th>
        <th>Suppr</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="btns">
    <button onclick="addRow()">‚ûï Ajouter ligne</button>
    <button onclick="window.print()">üñ®Ô∏è Imprimer / PDF</button>
    <button onclick="envoyerGoogleSheet()">üíæ Enregistrer dans Google Sheets</button>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx3M2EARO_McuH8ahoJEARDkg3aqVfx-hDl4OFXIANukofmMO1IhctQtswahwlxemmVqA/exec"; // Replace with your Web App URL

function addRow() {
  const tbody = document.querySelector("#table tbody");
  const date = document.getElementById("dateBon").value;
  const numero = document.getElementById("numero").value;
  const fournisseur = document.getElementById("clientSelect").value;

  if(!date || !numero || !fournisseur) { alert("Remplir la date, num√©ro et fournisseur !"); return; }

  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${date}</td>
    <td>${numero}</td>
    <td>${fournisseur}</td>
    <td><button onclick="removeRow(this)">‚úñ</button></td>
  `;
  tbody.appendChild(row);
}

function removeRow(btn) { btn.closest("tr").remove(); }

async function genererNumeroBon() {
  const fournisseur = document.getElementById("clientSelect").value;
  const url = `${WEB_APP_URL}?fournisseur=${encodeURIComponent(fournisseur)}`;

  try {
    const res = await fetch(url);
    const data = await res.json();
    if(data.numero) document.getElementById("numero").value = data.numero;
    else alert("Erreur: " + (data.error || "Num√©ro introuvable"));
  } catch(err) {
    console.error(err);
    alert("Erreur lors de la g√©n√©ration du num√©ro.");
  }
}

async function envoyerGoogleSheet() {
  const tbody = document.querySelector("#table tbody");
  const rows = Array.from(tbody.querySelectorAll("tr")).map(tr => {
    const tds = tr.querySelectorAll("td");
    return { date: tds[0].innerText, numero: tds[1].innerText, fournisseur: tds[2].innerText };
  });

  if(rows.length === 0) { alert("Aucune ligne √† envoyer !"); return; }

  try {
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ rows })
    });
    const result = await res.json();
    if(result.success) alert("‚úÖ Bon enregistr√© !");
    else alert("‚ùå Erreur: " + (result.error || "Impossible d'enregistrer"));
  } catch(err) {
    console.error(err);
    alert("Erreur lors de l'envoi au serveur.");
  }
}

// Init
window.onload = () => {
  document.getElementById("dateBon").value = new Date().toISOString().slice(0,10);
};
</script>

</body>
</html>

