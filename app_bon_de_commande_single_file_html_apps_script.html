<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Application Bon de Commande</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:18px;background:#f6f7fb}
    .card{background:#fff;padding:14px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.08)}
    h1{margin:0 0 12px;font-size:20px}
    label{display:block;margin-top:8px;font-size:13px}
    input,select,textarea{width:100%;padding:8px;border-radius:4px;border:1px solid #ccc;box-sizing:border-box}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #ddd;padding:8px;text-align:left}
    .btn{display:inline-block;padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
    .btn-primary{background:#2b6cb0;color:#fff}
    .btn-ghost{background:transparent;border:1px solid #ccc}
    .row{display:flex;gap:10px}
    .col{flex:1}
    .small{font-size:12px;color:#666}
    .print-area{display:none}
    @media print{body>*:not(.print-area){display:none} .print-area{display:block}}
  </style>
</head>
<body>

  <div class="card">
    <h1>Application - Bon de Commande</h1>

    <div class="row">
      <div class="col">
        <label>Fournisseur</label>
        <select id="supplierSelect"></select>
      </div>
      <div class="col">
        <label>Date</label>
        <input type="date" id="bcDate">
      </div>
      <div class="col">
        <label>Numéro BC</label>
        <input type="text" id="bcNumber" placeholder="ex: 247/2025">
      </div>
    </div>

    <h3 style="margin-top:14px">Lignes de commande</h3>
    <table id="linesTable">
      <thead>
        <tr><th>Code</th><th>Désignation</th><th>Quantité</th><th>Un.</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="btn btn-ghost" id="addLineBtn">➕ Ajouter une ligne</button>

    <div style="margin-top:14px;display:flex;gap:8px">
      <button class="btn btn-primary" id="saveBtn">Enregistrer</button>
      <button class="btn" id="previewBtn">Imprimer</button>
      <button class="btn btn-ghost" id="clearBtn">Effacer</button>
    </div>

    <div id="status" class="small" style="margin-top:10px"></div>
  </div>

  <div class="print-area card" id="printArea">
    <div id="printContent"></div>
  </div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwN2BfhrnPnrc05sDcou3GeWjfgbSz_LmVvjjXo5AeE6m1ZwJA_5BPOGy3jkGN_qcgI/exec"; // <<< IMPORTANT

function qs(id){return document.getElementById(id)}

document.addEventListener("DOMContentLoaded", ()=>{
  qs('bcDate').value = new Date().toISOString().slice(0,10);
  loadSuppliers();
  addLine();
  qs('addLineBtn').onclick = addLine;
  qs('saveBtn').onclick = saveOrder;
  qs('previewBtn').onclick = previewPrint;
  qs('clearBtn').onclick = clearForm;
});

async function loadSuppliers(){
  try{
    const res = await fetch(`${SCRIPT_URL}?action=listSuppliers`);
    const data = await res.json();
    const sel = qs('supplierSelect');
    sel.innerHTML = "";
    data.forEach(s=>{
      const opt = document.createElement("option");
      opt.value = s.Nom;
      opt.textContent = `${s.Nom} — ${s["Adresse / Zone dépôt"]}`;
      sel.appendChild(opt);
    });
  }catch(e){
    qs('status').textContent = "Erreur chargement fournisseurs : " + e.message;
  }
}

function addLine(){
  const tbody = qs("linesTable").querySelector("tbody");
  let tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input class="code"></td>
    <td><input class="des"></td>
    <td><input class="qty" type="number"></td>
    <td><input class="unit"></td>
    <td><button class="btn btn-ghost remove">Suppr</button></td>
  `;
  tbody.appendChild(tr);
  tr.querySelector(".remove").onclick = ()=>tr.remove();
}

function getLines(){
  return [...qs("linesTable tbody").children].map(r=>({
    code:r.querySelector(".code").value,
    des:r.querySelector(".des").value,
    qty:r.querySelector(".qty").value,
    unit:r.querySelector(".unit").value
  })).filter(l=>l.code || l.des);
}

async function saveOrder(){
  const payload = {
    action:"saveOrder",
    supplier:qs("supplierSelect").value,
    date:qs("bcDate").value,
    number:qs("bcNumber").value,
    lines:getLines()
  };

  qs("status").textContent = "Enregistrement...";

  try{
    const res = await fetch(SCRIPT_URL,{
      method:"POST",
      mode:"cors",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    const j = await res.json();
    qs("status").textContent = j.success ? "Enregistré !" : "Erreur : " + j.error;
  }catch(e){
    qs("status").textContent = "Erreur : " + e.message;
  }
}

function previewPrint(){
  const lines = getLines();
  let html = `
    <h2>BON DE COMMANDE</h2>
    <p><strong>Fournisseur :</strong> ${qs("supplierSelect").value}</p>
    <p><strong>Date :</strong> ${qs("bcDate").value} — <strong>N° :</strong> ${qs("bcNumber").value}</p>
    <table style="border-collapse:collapse;width:100%">
      ${lines.map(l=>`<tr><td>${l.code}</td><td>${l.des}</td><td>${l.qty}</td><td>${l.unit}</td></tr>`).join("")}
    </table>
  `;
  qs("printContent").innerHTML = html;
  window.print();
}

function clearForm(){
  qs("bcNumber").value="";
  qs("linesTable tbody").innerHTML="";
  addLine();
}
</script>

</body>
</html>
